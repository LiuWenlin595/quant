#!/usr/bin/env python
# coding: utf-8

# In[19]:

import pandas as pd
from typing import Dict,List
from scr.pattern_detect import find_RoundingBottom
from scr.plotting import view_gride_chart


# # 数据读取
# 
# - 时间范围:2014-01-01至2023-02-07
# - 价格数据为后复权数据

# In[3]:

data:pd.DataFrame = pd.read_csv('data/data.csv',index_col=[0,1],parse_dates=[0])


# # 形态匹配
# 
# ## 形态定义
# 
# 1. 取当日向前追溯两年的股价数据进行**核回归**,根据核回归的结果找到所有局部极值点,对于每个极小值点$𝑃_{𝑙𝑜𝑤}$,找到其前面一个极大值点;
# 2. 在这个极大值点的邻域中(本文取前后20天范围内)找到股价序列的最大值,作为前一盘整区的高点,记为$𝑃_{ℎ𝑖𝑔ℎ}$，定义$𝑃_{ℎ𝑖𝑔ℎ}$到$𝑃_{𝑙𝑜𝑤}$的水平距离为圆弧的半弦长𝑑(要求𝑑大于10天);
# 3. 定义在$P_{𝑙𝑜𝑤}$前后𝑑天范围内的股价序列为s,收益率绝对值序列为r,检验是否满足圆弧底形态的条件:
#    1. s在$P_{low}$左(右)侧下跌(上涨)的所占比例大于某一参数(本文取0.4);
#    2. r的均值小于某一参数(本文取0.03);
#    3. $(P_{ℎ𝑖𝑔ℎ}⁄P_{low} − 1)/𝑑$、$(P_{𝑏𝑢𝑦}⁄P_{low}− 1)/𝑑$小于某一参数(本文取0.03);
# 4. 若识别为圆弧底形态,则在s的右半部分寻找是否存在大于$P_{ℎ𝑖𝑔ℎ}$且已经突破200日均线的点,若存在,则将第一个突破$P_{ℎ𝑖𝑔ℎ}$的点作为买入点$𝑃_{𝑏𝑢𝑦}$。同时要求$(1 − p) ∗ (P_{ℎ𝑖𝑔ℎ} − 𝑃_{𝑙𝑜𝑤}) < 𝑃_{𝑏𝑢𝑦} − 𝑃_{𝑙𝑜𝑤} < (1 + p) ∗ (P_{ℎ𝑖𝑔ℎ} − 𝑃_{𝑙𝑜𝑤})$(本文中p取0.3);
# 
# 
# **下面为出现圆弧底时对应的买入/卖出点**
# 
# 5. 若开仓后的某日回归曲线中$𝑃_{𝑙𝑜𝑤}后面出现一个极大值点,则把当日作为卖出点$𝑃_{𝑠𝑒𝑙𝑙}$;
# 6. 如果下跌幅度超过10%则触发止损条件,卖出股票;
# 7. 对于其他极小值点-极大值点组合,重复上述过程。
# 
# 除了找到极值点用到了核回归的结果,其他步骤用的都是实际的价格数据.
# 
# ![avatar](data:image/png;base64,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