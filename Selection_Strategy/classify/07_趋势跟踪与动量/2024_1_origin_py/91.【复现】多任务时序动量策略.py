#!/usr/bin/env python
# coding: utf-8

# 
# ## 传统动量策略
# $$r^{TSMOM,i}_{t,t+1}=sgn(r^{i}_{t-252,t})\frac{\sigma_{tgt}}{\sigma^{i}_{t}}r^{i}_{t,t+1} \tag{1}$$
# $$sgn(x):=\begin{cases}1\ if\ x>0,\\
#                        0\ if\ x=0, \\
#                       -1\ if\ x<0
#             \end{cases} \tag{2}$$
# 
# 其中:
# $r^{i}_{t-252,t}$为资产i,t时刻过去一年的收益率;$r^{i}_{t,t+1}$为资产i,t时刻的收益率;$\sigma_{tgt}$目标年化波动率;$\sigma^{i}_{t}$资产i的历史波动率,计算窗口期为60日,使用指数衰减权重计算。
# 
# 最终资产组合可以表达为:
# $$r^{TSMOM}_{t,t+1}=\frac{1}{S_t}\sum^{S_t}_{i=1}r^{TSMOM,i}_{t,t+1} \tag{3}$$
# 
# 其中:$S_t$为组合在t时刻的标的数量
# 
# ## 模型架构
# ![avatar](data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAA1IAAAMCCAYAAABjqPfwAAAgAElEQVR4AeydB5wURdrGZwNLRhFBxYAoBswkURCUpKCInjmeAf3M4cRw6mEOGBBBBCNG1Dsj6olZEcGECmdERYmS88ZJz/d7qued7R0XZWHDTM8z0FvV3dXVVf+q7q6n36rqEPQTAREQAREQAREQAREQAREQARGoEoFQlUIrsAiIgAiIgAiIgAiIgAiIgAiIACSkVAlEQAREQAREQAREQAREQAREoIoEJKSqCEzBRUAEREAEREAEREAEREAEREBCSnVABERABERABERABERABERABKpIQEKqisAUXAREQAREQAREQAREQAREQASqSEBCqorAFFwEREAEREAEREAEREAEREAEJKRUB0RABERABERABERABERABERKCKBCSkqghMwUVABERABERABERABERABERAQkp1QAREQAREQAREQAREQAREQASqSEBCqorAFFwEREAEREAEREAEREAEREAEJKRUB0RABERABERABERABERABESgigQkpKoITMFFQAREQAREQAREQAREQAREBCSnVABERABERABERABERABERABKpIQEKqisAUXAREQAREQAREQAREQAREQAQkpFQHREAEREAEREAEREAEREAERKCKBCSkqghMwUVABERABERABERABERABERAQkp1QAREQAREQAREQAREQAREQASqSEBCqorAFFwEREAEREAEREAEREAEREAEJKRUB0RABERABERABERABERABESgigQkpKoITMFFQAREQAREQAREQAREQAREBCSnVABERABERABERABERABERABKpIQEKqisAUXAREQAREQAREQAREQAREQAQkpFQHREAEREAEREAEREAEREAERKCKBCSkqghMwUVABERABERABERABERABERAQkp1QAREQAREQAREQAREQAREQASqSEBCqorAFFwEREAEREAEREAEREAEREAEJKRUB0RABERABERABERABERABESgigQkpKoITMFFQAREQAREQAREQAREQAREQEJKRUB0RABERABERABERABERABEREAEqkhAQqqKwBRcBERABERABERABERABERABCSkVAdEQAREQAREQAREQAREQAREoIoEJKSqCEzBRUAEREAEREAEREAEREAEREBCSnVABERABERABERABERABERABKpIQEKqisAUXAREQAREQAREQAREQAREQAQkpFQHREAEREAEREAEREAEREAERKCKBCSkqghMwUVABERABERABERABERABERAQkp1QAREQAREQAREQAREQAREQASqSEBCqorAFFwEREAEREAEREAEREAEREAEJKRUB0RABERABERABERABERABESgigQkpKoITMFFQAREQAREQAREQAREQAREQEJKdUAEREAEREAEREAEREAEREAEqkhAQqqKwBRcBERABERABERABERABERABCSkVAdEQAREQAREQAREQAREQAREoIoEJKSqCEzBRUAEREAEREAEREAEREAEREBCSnVABERABERABERABERABERABKpIQEKqisAUXAREQAREQAREQAREQAREQAQkpFQHREAEREAEREAEREAEREAERKCKBCSkqghMwUVABERABERABERABERABERAQkp1QAREQAREQAREQAREQAREQASqSEBCqorAFFwEREAEREAEREAEREAEREAEJKRUB0RABERABERABERABERABESgigQkpKoITMFFQAREQAREQAREQAREQAREQEJKdUAEREAEREAEREAEREAEREAEqkhAQqqKwBRcBERABERABERABERABERABCSkVAdEQAREQAREQAREQAREQAREoIoEJKSqCEzBRUAEREAEREAEREAEREAEREBCSnVABERABERABERABERABERABKpIQEKqisAUXAREQAREQAREQAREQAREQAQkpFQHREAEREAEREAEREAEREAERKCKBCSkqghMwUVABERABERABERABERABERAQkp1QAREQAREQAREQAREQAREQASqSEBCqorAFFwEREAEREAEREAEREAEREAEJKRUB0RABERABERABERABERABESgigQkpKoITMFFQAREQAREQAREQAREQAREQEJKdUAEREAEREAEREAEREAEREAEqkhAQqqKwBRcBERABERABERABERABERABCSkVAdEQAREQAREQAREQAREQAREoIoEJKSqCEzBRUAEREAEREAEREAEREAEREBCSnVABERABERABERABERABERABKpIQEKqisAUXAREQAREQAREQAREQAREQAQkpFQHREAEREAEREAEREAEREAERKCKBCSkqghMwUVABERABERABERABERABERAQkp1QAREQAREQAREQAREQAREQASqSEBCqorAFFwEREAEREAEREAEREAEREAEJKRUB0RABERABERABERABERABESgigQkpKoITMFFQAREQAREQAREQAREQAREQEJKdUAEREAEREAEREAEREAEREAEqkhAQqqKwBRcBERABERABERABERABERABCSkVAdEQAREQAREQAREQAREQAREoIoEJKSqCEzBRUAEREAEREAEREAEREAEREBCSnVABERABERABERABERABERABKpIQEKqisAUXAREQAREQAREQAREQAREQAQkpFQHREAEREAEREAEREAEREAERKCKBCSkqghMwUVABERABERABERABERABERAQkp1QAREQAREQAREQAREQAREQASqSEBCqorAFFwEREAEREAEREAEREAEREAEJKRUB0RABERABERABERABERABESgigQkpKoITMFFQAREQAREQAREQAREQAREQEJKdUAEREAEREAEREAEREAEREAEqkhAQqqKwBRcBERABERABERABERABERABCSkVAdEQAREQAREQAREQAREQAREoIoEJKSqCEzBRUAEREAEREAEREAEREAEREBCSnVABERABERABERABERABERABKpIQEKqisAUXAREQAREQAREQAREQAREQAQkpFQHREAEREAEREAEREAEREAERKCKBCSkqghMwUVABERABERABERABERABERAQkp1QAREQAREQAREQAREQAREQASqSEBCqorAFFwEREAEREAEREAEREAEREAEJKRUB0RABERABERABERABERABESgigQkpKoITMFFQAREQAREQAREQAREQAREQEJKdUAEREAEREAEREAEREAEREAEqkhAQqqKwBRcBERABERABERABERABERABCSkVAdEQAREQAREQAREQAREQAREoIoEJKSqCEzBRUAEREAEREAEREAEREAEREBCSnVABERABERABERABERABERABKpIQEKqisAUXAREQAREQAREQAREQAREQAQkpFQHREAEREAEREAEREAEREAERKCKBCSkqghMwUVABERABERABERABERABERAQkp1QAREQAREQAREQAREQAREQASqSEBCqorAFFwEREAEREAEREAEREAEREAEJKRUB0RABERABERABERABERABESgigQkpKoITMFFQAREQAREQAREQAREQAREQEJKdUAEREAEREAEREAEREAEREAEqkhAQqqKwBRcBERABERABERABERABERABCSkVAdEQAREQAREQAREQAREQAREoIoEJKSqCEzBRUAEREAEREAEREAEREAEREBCSnVABERABERABERABERABERABKpIQEKqisAUXAREQAREQAREQAREQAREQAQkpFQHREAEREAEREAEREAEREAERKCKBCSkqghMwUVABERABERABERABERABERAQkp1QAREQAREQAREQAREQAREQASqSEBCqorAFFwEREAEREAEREAEREAEREAEJKRUB0RABERABERABERABERABESgigQkpKoITMFFQAREQAREQAREQAREQAREQEJKdUAEREAEREAEREAEREAEREAEqkhAQqqKwBRcBERABERABERABERABERABCSkVAdEQAREQAREQAREQAREQAREoIoEJKSqCEzBRUAEREAEREAEREAEREAEREBCSnVABERABERABERABERABERABKpIQEKqisAUXAREQAREQAREQAREQAREQAQkpFQHREAEREAEREAEREAEREAERKCKBCSkqghMwUVABERABERABERABERABERAQkp1QAREQAREQAREQAREQAREQASqSEBCqorAFFwEREAEREAEREAEREAEREAEJKRUB0RABERABERABERABERABESgigQkpKoITMFFQAREQAREQAREQAREQAREQEJKdUAEREAEREAEREAEREAEREAEqkhAQqqKwBRcBERABERABERABERABERABCSkVAdEQAREQAREQAREQAREQAREoIoEJKSqCEzBRUAEREAEREAEREAEREAEREBCSnVABERABERABERABERABERABKpIQEKqisAUXAREQAREQAREQAREQAREQAQkpFQHREAEREAEREAEREAEREAERKCKBCSkqghMwUVABERABERABERABERABERAQkp1QAREQAREQAREQAREQAREQASqSEBCqorAFFwEREAEREAEREAEREAEREAEJKRUB0RABERABERABERABERABESgigQkpKoITMFFQAREQAREQAREQAREQAREQEJKdUAEREAEREAEREAEREAEREAEqkhAQqqKwBRcBERABERABERABERABERABCSkVAdEQAREQAREQAREQAREQAREoIoEJKSqCEzBRUAEREAEREAEREAEREAEREBCSnVABERABERABERABERABERABKpIQEKqisAUXAREQAREQAREQAREQAREQAQkpFQHREAEREAEREAEREAEREAERKCKBCSkqghMwUVABERABERABERABERABERAQkp1QAREQAREQAREQAREQAREQASqSEBCqorAFFwEREAEREAEREAEREAEREAEJKRUB0RABERABERABERABERABESgigQkpKoITMFFQAREQAREQAREQAREQAREQEJKdUAEREAEREAEREAEREAEREAEqkhAQqqKwBRcBERABERABERABERABERABCSkVAdEQAREQAREQAREQAREQAREoIoEJKSqCEzBRUAEREAEREAEREAEREAEREBCSnVABERABERABERABERABERABKpIQEKqisAUXAREQAREQAREQAREQAREQAQkpFQHREAEREAEREAEREAEREAERKCKBCSkqghMwUVABERABERABERABERABERAQkp1QAREQAREQAREQAREQAREQASqSEBCqorAFFwEREAEREAEREAEREAEREAEJKRUB0RABERABERABERABERABESgigQkpKoITMFFQAREQAREQAREQAREQAREQEJKdUAEREAEREAEREAEREAEREAEqkhAQqqKwBRcBERABERABERABERABERABCSkVAdEQAREQAREQAREQAREQAREoIoEJKSqCEzBRUAEREAEREAEREAEREAEREBCSnVABERABERABERABERABERABKpIQEKqisAUXAREQAREQAREQAREQAREQAQkpFQHREAEREAEREAEREAEREAERKCKBCSkqghMwUVABERABERABERABERABERAQkp1QAREQAREQAREQAREQAREQASqSEBCqorAFFwEREAEREAEREAEREAEREAEJKRUB0RABERABERABERABERABESgigQkpKoITMFFQAREQAREQAREQAREQAREQEJKdUAEREAEREAEREAEREAEREAEqkhAQqqKwBRcBERABERABERABERABERABCSkVAdEQAREQAREQAREQAREQAREoIoEJKSqCEzBRUAEREAEREAEREAEREAEREBCSnVABERABERABERABERABERABKpIQEKqisAUXAREQAREQAREQAREQAREQAQkpFQHREAEREAEREAEREAEREAERKCKBCSkqghMwUVABERABERABERABERABERAQkp1QAREQAREQAREQAREQAREQASqSEBCqorAFFwEREAEREAEREAEREAEREAEJKRUB0RABERABERABERABERABESgigQkpKoITMFFQAREQAREQAREQAREQAREQEJKdUAEREAEREAEREAEREAEREAEqkhAQqqKwBRcBERABERABERABERABERABCSkVAdEQAREQAREQAREQAREQAREoIoEJKSqCEzBRUAEREAEREAEREAEREAEREBCSnVABERABERABERABERABERABKpIQEKqisAUXAREQAREQAREQAREQAREQAQkpFQHREAEREAEREAEREAEREAERKCKBCSkqghMwUVABERABERABERABERABERAQkp1QAREQAREQAREQAREQAREQASqSEBCqorAFFwEREAEREAEREAEREAEREAEJKRUB0RABERABERABERABERABESgigQkpKoITMFFQAREQAREQAREQAREQAREQEJKdUAEREAEREAEREAEREAEREAEqkhAQqqKwBRcBERABERABERABERABERABCSkVAdEQAREQAREQAREQAREQAREoIoEJKSqCEzBRUAEREAEREAEREAEREAEREBCSnVABERABERABERABERABERABKpIQEKqisAUXAREQAREQAREQAREQAREQAQkpFQHREAEREAEREAEREAEREAERKCKBCSkqghMwUVABERABERABERABERABERAQkp1QAREQAREQAREQAREQAREQASqSEBCqorAFFwEREAEREAEREAEREAEREAEJKRUB0RABERABERABERABERABESgigQkpKoITMFFQAREQAREQAREQAREQAREQEJKdUAEREAEREAEREAEREAEREAEqkhAQqqKwBRcBERABERABERABERABERABCSkVAdEQAREQAREQAREQAREQAREoIoEJKSqCEzBRUAEREAEREAEREAEREAEREBCSnVABERABERABERABERABERABKpIQEKqisAUXAREQAREQAREQAREQAREQAQkpFQHREAEREAEREAEREAEREAERKCKBCSkqghMwUVABERABERABERABERABERAQkp1QAREQAREQAREQAREQAREQASqSEBCqorAFFwEREAEREAEREAEREAEREAEJKRUB0RABERABERABERABERABESgigQkpKoITMFFQAREQAREQAREQAREQAREQEJKdUAEREAEREAEREAEREAEREAEqkhAQqqKwBRcBERABERABERABERABERABCSkVAdEQAREQAREQAREQAREQAREoIoEJKSqCEzBRUAEREAEREAEREAEREAEREBCSnVABERABERABERABERABERABKpIQEKqisAUXAREQAREQAREQAREQAREQAQkpFQHREAEREAEREAEREAEREAERKCKBCSkqghMwUVABERABERABERABERABERAQkp1QAREQAREQAREQAREQAREQASqSEBCqorAFFwEREAEREAEREAEREAEREAEJKRUB0RABERABERABERABERABESgigQkpKoITMFFQAREQAREQAREQAREQAREQEJKdUAEREAEREAEREAEREAEREAEqkhAQqqKwBRcBERABERABERABERABERABCSkVAdEQAREQAREQAREQAREQAREoIoEJKSqCEzBRUAEREAEREAEREAEREAEREBCSnVABERABERABERABERABERABKpIQEKqisAUXAREQAREQAREQAREQAREQAQkpFQHREAEREAEREAEREAEREAERKCKBCSkqghMwUVABERABERABERABERABERAQkp1QAREQAREQAREQAREQAREQASqSEBCqorAFFwEREAEREAEREAEREAEREAEJKRUB0RABERABERABERABERABESgigQkpKoITMFFQAREQAREQAREQAREQAREQEJKdUAEREAEREAEREAEREAEREAEqkhAQqqKwBRcBERABERABERABERABERABCSkVAdEQAREQAREQAREQAREQAREoIoEJKSqCEzBRUAEREAEREAEREAEREAEREBCSnVABERABERABERABERABERABKpIQEKqisAUXAREQAREQAREQAREQAREQAQkpFQHREAEREAEREAEREAEREAERKCKBCSkqghMwUVABERABERABERABERABERAQkp1QAREQAREQAREQAREQAREQASqSEBCqorAFFwEREAEREAEREAEREAEREAEJKRUB0RABERABERABERABERABESgigQkpKoITMFFQAREQAREQAREQAREQAREQEJKdUAEREAEREAEREAEREAEREAEqkhAQqqKwBRcBERABERABERABERABERABCSkVAdEQAREQAREQAREQAREQAREoIoEJKSqCEzBRUAEREAEREAEREAEREAEREBCSnVABERABERABERABERABERABKpIQEKqisAUXAREQAREQAREQAREQAREQAQkpFQHREAEREAEREAEREAEREAERKCKBCSkqghMwUVABERABERABERABERABERAQkp1QAREQAREQAREQAREQAREQASqSEBCqorAFFwEREAEREAEREAEREAEREAEJKRUB0RABERABERABERABERABESgigQkpKoITMFFQAREQAREQAREQAREQAREQEJKdUAEREAEREAEREAEREAEREAEqkhAQqqKwBRcBERABERABERABERABERABCSkVAdEQAREQAREQAREQAREQAREoIoEJKSqCEzBRUAEREAEREAEREAEREAEREBCSnVABERABERABERABERABERABKpIQEKqisAUXAREQAREQAREQAREQAREQAQkpFQHREAEREAEREAEREAEREAERKCKBCSkqghMwUVABERABERABERABERABERAQkp1QAREQAREQAREQAREQAREQASqSEBCqorAFFwEREAEREAEREAEREAEREAEJKRUB0RABERABERABERABERABESgigQkpKoITMFFQAREQAREQAREQAREQAREQEJKdUAEREAEREAEREAEREAEREAEqkhAQqqKwBRcBERABERABERABERABERABCSkVAdEQAREQAREQAREQAREQAREoIoEJKSqCEzBRUAEREAEREAEREAEREAEREBCSnVABERABERABERABERABERABKpIQEKqisAUXAREQAREQAREQAREQAREQAQkpFQHREAEREAEREAEREAEREAERKCKBCSkqghMwUVABERABERABERABERABERAQkp1QAREQAREQAREQAREQAREQASqSEBCqorAFFwEREAEREAEREAEREAEREAEJKRUB0RABERABERABERABERABESgigQkpKoITMFFQAREQAREQAREQAREQAREQEJKdUAEREAEREAEREAEREAEREAEqkhAQqqKwBRcBERABERABERABERABERABCSkVAdEQAREQAREQAREQAREQAREoIoEJKSqCEzBRUAEREAEREAEREAEREAEREBCSnVABERABERABERABERABERABKpIQEKqisAUXAREQAREQAREQAREQAREQAQkpFQHREAEREAEREAEREAEREAERKCKBCSkqghMwUVABERABERABERABERABERAQkp1QAREQAREQAREQAREQAREQASqSEBCqorAFFwEREAEREAEREAEREAEREAEJKRUB0RABERABERABERABERABESgigQkpKoITMFFQAREQAREQAREQAREQAREQEJKdUAEREAEREAEREAEREAEREAEqkhAQqqKwBRcBERABERABERABERABERABCSkVAdEQAREQAREQAREQAREQAREoIoEJKSqCEzBRUAEREAEREAEREAEREAEREBCSnVABERABERABERABERABERABKpIQEKqisAUXAREQAREQAREQAREQAREQAQkpFQHREAEREAEREAEREAEREAERKCKBCSkqghMwUVABERABERABERABERABERAQkp1QAREQAREQAREQAREQAREQASqSEBCqorAFFwEREAEREAEREAEREAEREAEJKRUB0RABERABERABERABERABESgigQkpKoITMFFQAREQAREQAREQAREQAREQEJKdUAEREAEREAEREAEREAEREAEqkhAQqqKwBRcBERABERABERABERABERABCSkVAdEQAREQAREQAREQAREQAREoIoEJKSqCEzBRUAEREAEREAEREAEREAEREBCSnVABERABERABERABERABERABKpIQEKqisAUXAREQAREQAREQAREQAREQAQkpFQHREAEREAEREAEREAEREAERKCKBCSkqghMwUVABERABERABERABERABERAQkp1QAREQAREQAREQAREQAREQASqSEBCqorAFFwEREAEREAEREAEREAEREAEJKRUB0RABERABERABERABERABESgigQkpKoITMFFQAREQAREQAREQAREQAREQEJKdUAEREAEREAEREAEREAEREAEqkhAQqqKwBRcBERABERABERABERABERABCSkVAdEQAREQAREQAREQAREQAREoIoEJKSqCEzBRUAEREAEREAEREAEREAEREBCSnVABERABERABERABERABERABKpIQEKqisAUXAREQAREQAREQAREQAREQAQkpFQHREAEREAEREAEREAEREAERKCKBCSkqghMwUVABERABERABERABERABERAQkp1QAREQAREQAREQAREQAREQASqSEBCqorAFFwEREAEREAEREAEREAEREAEJKRUB0RABERABERABERABERABESgigQkpKoITMFFQAREQAREQAREQAREQAREQEJKdUAEREAEREAEREAEREAEREAEqkhAQqqKwBRcBERABERABERABERABERABCSkVAdEQAREQAREQAREQAREQAREoIoEJKSqCEzBRUAEREAEREAEREAEREAEREBCSnVABERABERABERABERABERABKpIQEKqisAUXAREQAREQAREQAREQAREQAQkpFQHREAEREAEREAEREAEREAERKCKBCSkqghMwUVABERABERABERABERABERAQkp1QAREQAREQAREQAREQAREQASqSEBCqorAFFwEREAEREAEREAEREAEREAEJKRUB0RABERABERABERABERABESgigQkpKoITMFFQAREQAREQAREQAREQAREQEJKdUAEREAEREAEREAEREAEREAEqkhAQqqKwBRcBERABERABERABERABERABCSkVAdEQAREQAREQAREQAREQAREoIoEJKSqCEzBRUAEREAEREAEREAEREAEREBCSnVABERABERABERABERABERABKpIQEKqisAUXAREQAREQAREQAREQAREQAQkpFQHREAEREAEREAEREAEREAERKCKBCSkqghMwUVABERABERABERABERABERAQkp1QAREQAREQAREQAREQAREQASqSEBCqorAFFwEREAEREAEREAEREAEREAEJKRUB0RABERABERABERABERABESgigQkpKoITMFFQAREQAREQAREQAREQAREQEJKdUAEREAEREAEREAEREAEREAEqkhAQqqKwBRcBERABERABERABERABERABCSkVAdEQAREQAREQAREQAREQ